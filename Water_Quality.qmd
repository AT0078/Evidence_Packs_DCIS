---
title: "Water Quality"
format: html
html:
    theme: flatly
    toc: true
    toc-location: right
    number-sections: false
    code-fold: false
    code-tools: false
    fig-cap: true
---

## Overall Physio-Chemical WFD 

Water quality is one of the three pillars of the ecological trinity of river health, alongside physical habitat and flow. You can have a river with perfect physical habitat and with natural annual flow, but if its water is polluted it won't realise its true ecological potential.
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, echo=FALSE, cache=TRUE)
```


```{r }
#| label: the general cps & cat

library(sf)
library(magrittr)
library(tidyverse)
library(leaflet)


source("Catch_Set_Up.R")
```


```{r}


library(leaflet)
library(dplyr)
library(magrittr)

# Load your data
CDE <- read.csv("/dbfs/mnt/lab/unrestricted/harry.gray@environment-agency.gov.uk/CEP/WFD_Wessex_2024.csv")

CDE %<>% 
  filter(Operational.Catchment == unique(CAT$OPCAT_NAME)) %>% 
  inner_join(CAT_geo, ., by = c("WB_ID" = "Water.Body.ID"))

# Define palette
pal <- colorFactor(
  palette = c("green", "seagreen", "seagreen", "yellow", "#c65102", "#b71105", "red"),
  levels = c("High", "Good", "Supports Good", "Moderate", "Bad", "Poor", "Fail"),
  na.color = "transparent"
)

# 2022 map
CDE_e_2022 <- CDE %>% 
  filter(Classification.Item == "Physio-Chemical Quality Elements" & 
         Year == sort(unique(CDE$Year), decreasing=TRUE)[1])

list <- unique(CDE[CDE$Classification.Item.Subgroup == "Physio-Chemical Quality Elements Group",]$Classification.Item)

```


Within the `r unique(CAT$OPCAT_NAME)`'s `r length(unique(CAT$WB_NAME))` individual EA waterbodies.

In the most recent WFD classification in `r sort(unique(CDE$Year), decreasing=TRUE)[1]`,  `r round(sum(CDE_e_2022$Status == "Good")/length(unique(CAT$WB_NAME))*100, digits=0)`% of waterbodies scored "Good" for `r unique(CDE_e_2022$Classification.Item)`. Whilst `r round(sum(CDE_e_2022$Status == "High")/length(unique(CAT$WB_NAME))*100, digits=0)`% of waterbodies scored "High". 

`r unique(CDE_e_2022$Classification.Item)` include the following items: `r cat(paste0("- ", list, collapse= "\n"))`

```{r}
cat(paste0("- ", list, collapse= "\n"))
```


```{r}
#| label: Ecological Overall CDE Map


# 2019 map
CDE_e_2019 <- CDE %>% 
  filter(Classification.Item == "Physio-Chemical Quality Elements" & 
         Year == "2019")

CDE_e_2015 <- CDE %>% 
  filter(Classification.Item == "Physio-Chemical Quality Elements" & 
         Year == "2015")

CDE_e <- CDE %>% 
         filter(Classification.Item == "Physio-Chemical Quality Elements" & 
         Year == c(2015, 2019, 2022))

         leaflet() %>% 
  addProviderTiles(providers$Esri,
                   group = "Esri Basemap") %>% 
   addPolygons(data= CDE_e_2015,
              color = "black",
              weight = 0.5,
              fillOpacity = 0.7,
              fillColor = ~pal(Status),
              popup= ~Water.Body,
              group= "2015 Status") %>% 
  addPolygons(data= CDE_e_2019,
              color = "black",
              weight = 0.5,
              fillOpacity = 0.7,
              fillColor = ~pal(Status),
              popup= ~Water.Body,
              group= "2019 Status") %>% 
  addPolygons(data= CDE_e_2022,
              color = "black",
              weight = 0.5,
              fillOpacity = 0.7,
              fillColor = ~pal(Status),
              popup= ~Water.Body,
              group = "2022 Status") %>% 
  addLegend(opacity = 0.9, 
            pal = pal,
            values = CDE_e_2022$Status,
            title = unique(CDE_e_2019$Classification.Item)) %>% 
  addLayersControl(baseGroups = c( "2022 Status",
              "2019 Status",
              "2015 Status"),
                   overlayGroups = c(
             "Esri Basemap"),
                   position = "topright",
                   options= layersControlOptions(collapsed=FALSE)) %>% 
  hideGroup(c("2019 Status",
              "2015 Status",
              "Esri Basemap"))



```

### Reasons for Not Acheiving Good

_caveat the only elements shown here are: "Ammonia (Phys-Chem)", 
                                            "Dissolved oxygen",
                                            "Temperature",
                                            "Phosphate",
                                            "Ammonia (Annex 8)", - need to find if there's more Phys Chem elements_
```{r RNAGS datatable}

# These are just for ecological quality elements

RNAG <- CPS_sf %>% 
                mutate(
                Date = as.Date(ymd_hms(CREATED_DATE))
                ) %>% 
               filter(CLASS_ITEM_NAME %in% c("Ammonia (Phys-Chem)", 
                                            "Dissolved oxygen",
                                            "Temperature",
                                            "Phosphate",
                                            "Ammonia (Annex 8)"
                                            )) %>% 
               # filter(hydromorph == "not designated artificial or heavily modified") %>%  # I think we should still consider A/HMWBs
                group_by(PRESSURE_NAME_1) %>% 
                filter(Date == sort(Date)[length(sort(Date))]) %>%   # We want the most recent creation date for each pressure
                ungroup() 


library(DT)
library(htmlwidgets)

DT::datatable(RNAG[,c(1, 11:32)],
          class = 'cell-border stripe',
          caption = 'Use the map below to find a waterbody and use the table search function to find its records',
          options = list(dom = 'Blfrtip', buttons = 'copy')
              )
            

```

### RNAGs map


RNAGs for Phys-Chemical Quality Elements are displayed in the map below, they are filtered to show the most recent RNAGs, those which are opaque are >5 years old and have a creation date of 1st January 2019. This surpasses the national KPI as it is four months ahead of the KPI target of 1st April 2019.

_Need to think of a way to visualise wbs with multiple Phys-Chem RNAGS as this seems to be more common than ecological quality RNAGS_
```{r Phys Chem RNAG Map}

       leaflet() %>% 
  addProviderTiles(providers$Esri) %>% 
    addPolygons(data=CAT_Union,
                        color="black",
                       weight = 2,
                       opacity = 0.99,
                       fillColor = NA,
                       fillOpacity = 0.00001
                  ) %>% 
    addPolygons(data=RNAG,
              color = "black",
              weight = 0.5,
              fillOpacity = ~ifelse(RNAG$Date < as.Date("2019-01-01"), 0.2, 0.99),
              fillColor = ~pal(RNAG$CLASSIFICATION_NAME),
              popup= paste0("RNAG Created: ",RNAG$Date, "<br>",
                            "Element: ", RNAG$CLASS_ITEM_NAME, "<br>",
                            "WB: ",RNAG$WB_NAME, "<br> Pressure 1: ",
                            RNAG$PRESSURE_NAME_1,
                            "<br> Pressure 2: ",
                            RNAG$PRESSURE_NAME_2,
                            "<br> RFF Action Name: " ,
                            RNAG$RFF_ACTION_NAME),
              group = "Invertebrates RNAGs")%>% 
                addLegend(opacity = 0.9, 
                         pal = pal,
                         values = RNAG$CLASSIFICATION_NAME,
                         title = "RNAG by Phys-Chem Quality Element") 
```


# WFD map for Phosphates/ Nitrates/ DO

# WIMS data

